---
title: "FIA Data"
author: "Ursa Pillay, Kathe Todd-Brown"
date: "April 2024"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{readTemplate Function}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

The FIADB

  + Burrill, Elizabeth A.; DiTommaso, Andrea M.; Turner, Jeffery A.; Pugh, Scott A.; Menlove, James; Christensen, Glenn; Perry, Carol J.; Conkling, Barbara L. 2023. The Forest Inventory and Analysis Database: database description and user guide version 9.1 for Phase 2. U.S. Department of Agriculture, Forest Service. 1066 p. [Online]. Available at web address: https://www.fia.fs.usda.gov/library/database-documentation/index.
  + Forest Inventory and Analysis. 2014. The Forest Inventory and Analysis Database: Database description and user guide version 6.0.1 for Phase 3. U.S. Department of Agriculture, Forest Service. 182 p. [Online]. Available: http://www.fia.fs.fed.us/library/database‚Äêdocumentation/.


```{r setup, echo=TRUE, warning=FALSE, message=FALSE}

library(readr) # read in the csv tables
library(tibble) # use tibbles instead of a data frame
library(plyr) # transform a list into a data frame for the bind
library(dplyr) # work with data tables and pivots
library(tidyr)
library(ggplot2)
source("../R/readFIA.R", local = knitr::knit_global())

#locate the data locally
dataDir <- '~/Desktop/datasets/fia'
dataDir  <- '~/UFL Dropbox/Katherine Todd-Brown/Research/Datasets/FS_FIA'
dataAnnotations <- '../data/fia_annotations.csv'
```

```{r, warning=FALSE}
fia.ls <- readFIA(dataDir, annotationFilename = dataAnnotations, verbose = TRUE)
```

```{r}
fia.ls$annotations %>%
  filter(is_type == 'description') %>%
  select(table_id, column_id, description = with_entry) %>%
  knitr::kable()
```

```{r}
soil_carbon.df <- fia.ls$longtable %>%
  filter(is_type == 'identifier' | 
           of_variable %in% c('Longtitude', 'Latitude', 'State',
                              #'Forest_floor_depth_avg', 'Litter_layer_depth_avg',
                              'Layer_type',
                              'Bulk_density',
                              'coarse_fraction',
                              'organic_carbon', 'carbon_fraction',
                              'inorganic_carbon')) %>%
  mutate(column_name = sprintf('%s.%s', of_variable, is_type),
         row_id = sprintf('%s.%s', table_id, row_number)) %>%
  select(row_id, column_name, with_entry) %>%
  pivot_wider(names_from = 'column_name', values_from = 'with_entry') %>%
  select(-row_id) %>%
  pivot_longer(cols = ! ends_with('identifier'), values_drop_na = TRUE) %>%
  pivot_wider() %>%
  filter(!is.na(Layer_type.value)) %>% #only keep observations that have soil information
  mutate(across(.cols = all_of('Longtitude.value', 'Latitude.value',
                               'Bulk_density.value',
                              'organic_carbon.value', 'carbon_fraction.value',
                              'inorganic_carbon.value'), as.numeric))

lapply(soil_carbon.df, FUN = function(xx){sum(!is.na(xx))})
```

- [] histogram for each numerical variable
- [] lat/lon map for locations

```{r}

ggplot(soil_carbon.df) +
  geom_point(aes(x=Bulk_density.value, y = organic_carbon.value), alpha = 0.1) +
  facet_wrap(~Layer_type.value, scales='free')
```
