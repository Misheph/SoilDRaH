---
title: "Forest Inventory Analysis Database"
author: "Ursa Pillay, Kathe Todd-Brown"
date: "April 2024"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{readTemplate Function}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

The purpose of this document is to summarize the portions of the Forest Inventory Analysis Database that are relevant to data collections in the SoilDRaH project and walk through the data ingestion.
Here you will find links to documentation from the data provider, links to where you can access the data, a description of how the data was processed, and visuals for the collection relevent variables.

# What is the FIADB

The version of the US Forest Service's Forest Inventory Analysis Database described here is the public facing version of the Forest Inventory and Analysis program.

> **Forest Inventory and Analysis**
For more than 80 years, the FIA program has been recognized as a world leader in conducting national-scale forest inventories. FIA information is widely used to address local and regional issues related to trends in forest extent, health and productivity; land cover and land use change; and the changing demographics of private forest landowners.

Taken from [https://www.fs.usda.gov/research/programs/fia](https://www.fs.usda.gov/research/programs/fia) (Accessed 16-May-2024)

Documentation for this database is concentrated in two documents below:

  + Burrill, Elizabeth A.; DiTommaso, Andrea M.; Turner, Jeffery A.; Pugh, Scott A.; Menlove, James; Christensen, Glenn; Perry, Carol J.; Conkling, Barbara L. 2023. The Forest Inventory and Analysis Database: database description and user guide version 9.1 for Phase 2. U.S. Department of Agriculture, Forest Service. 1066 p. [Online]. Available at web address: https://www.fia.fs.usda.gov/library/database-documentation/index.
  + Forest Inventory and Analysis. 2014. The Forest Inventory and Analysis Database: Database description and user guide version 6.0.1 for Phase 3. U.S. Department of Agriculture, Forest Service. 182 p. [Online]. Available: http://www.fia.fs.fed.us/library/database‚Äêdocumentation/.

The annotations table draws heavily on these two documents with augmentation from private communication with Forest Service scientist.

# Data processing

```{r setup, echo=TRUE, warning=FALSE, message=FALSE}

library(readr) # read in the csv tables
library(tibble) # use tibbles instead of a data frame
library(plyr) # transform a list into a data frame for the bind
library(dplyr) # work with data tables and pivots
library(tidyr)
library(ggplot2)
library(stringr)
library(knitr)
library(kableExtra)

source("../R/readFIA.R", local = knitr::knit_global())

#locate the data locally
dataDir <- '~/Desktop/datasets/fia'
dataDir  <- '~/UFL Dropbox/Katherine Todd-Brown/Research/Datasets/FS_FIA'
dataAnnotations <- '../data/fia_annotations.csv'
```

```{r, warning=FALSE}
fia.ls <- readFIA(dataDir, annotationFilename = dataAnnotations, verbose = TRUE, format = 'long')
```
# Tables

There are six tables currently annotated in the FIADB data collection.
This represents the data directly relevant for layer-level soil carbon measurements including bulk density, organic carbon fraction, coarse fraction, depth of sample, sampling time, and sample location.
Below are the descriptions of data columns organized by table.

Please note that there is quite a bit more data in the FIADB and we welcome interested parties extending these annotations.

## Table: `ENTIRE_SURVEY`

```{r}
knitr::kable(fia.ls$annotations %>%
               filter(is_type == 'description',
                      table_id == 'ENTIRE_SURVEY') %>%
               select(column_id, of_variable, description = with_entry)) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "300px")
```

## Table: `ENTIRE_PLOT`

```{r}
knitr::kable(fia.ls$annotations %>%
               filter(is_type == 'description',
                      table_id == 'ENTIRE_PLOT') %>%
               select(column_id, of_variable, description = with_entry)) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "300px")
```

## Table: `ENTIRE_SOILS_VISIT`

```{r}
knitr::kable(fia.ls$annotations %>%
               filter(is_type == 'description',
                      table_id == 'ENTIRE_SOILS_VISIT') %>%
               select(column_id, of_variable, description = with_entry)) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "300px")
```

## Table: `ENTIRE_SOILS_SAMPLE_LOC` 

```{r}
knitr::kable(fia.ls$annotations %>%
               filter(is_type == 'description',
                      table_id == 'ENTIRE_SOILS_SAMPLE_LOC') %>%
               select(column_id, of_variable, description = with_entry)) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "300px")
```

## Table: `ENTIRE_SOILS_EROSION`

```{r}
knitr::kable(fia.ls$annotations %>%
               filter(is_type == 'description',
                      table_id == 'ENTIRE_SOILS_VISIT') %>%
               select(column_id, of_variable, description = with_entry)) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "300px")
```

## Table: `ENTIRE_SOILS_LAB`

```{r}
knitr::kable(fia.ls$annotations %>%
               filter(is_type == 'description',
                      table_id == 'ENTIRE_SOILS_VISIT') %>%
               select(column_id, of_variable, description = with_entry)) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "300px")
```

# Data processing

## `readFIA` function

This code mirrors the code that is in the `readFIA` function.

```{r eval=FALSE}

fia.ls <- readFIA(dataDir, annotationFilename = dataAnnotations, verbose = TRUE, format = 'original')

# Notes from P2 guide
# ENTIRE_PLOT::SRV_CN links to ENTIRE_SURVEY::CN
# Notes from P3 guide
# ENTIRE_SOILS_VISIT::PLT_CN links to ENTIRE_PLOT:CN
# ENTIRE_SOILS_EROSION::PLT_CN links to ENTIRE_PLOT:CN
# ENTIRE_SOILS_SAMPLE_LOC::PLT_CN links to ENTIRE_PLOT:CN
# ENTIRE_SOILS_LAB::PLT_CN links to ENTIRE_PLOT:CN

#CN is always a row identifier for each table but there is no assurance it is unique across the data set
#Natural identifiers in each table are:
# ENTIRE_PLOT => STATECD, INVYR, UNITCD, COUNTYCD, PLOT
# ENTIRE_SOILS_VISIT => STATECD, INVYR, COUNTYCD, PLOT
# ENTIRE_SOILS_EROSION => STATECD, INVYR, COUNTYCD, PLOT, SUBP
# ENTIRE_SOILS_SAMPLE_LOC => STATECD, INVYR, COUNTYCD, PLOT, SMPLNNBR
# ENTIRE_SOILS_LAB => STATECD, INVYR, COUNTYCD, PLOT, SMPLNNBR, LAYER_TYPE

allData <- fia.ls$original_data$ENTIRE_PLOT %>%
  #rename the plot CN to match the foreign key in other tables
  mutate(PLT_CN = CN) %>% 
  #add in the table name to columns
  rename_with(.cols = !PLT_CN, ~paste0(.x, '.ENTIRE_PLOT')) %>%
  right_join(fia.ls$original_data$ENTIRE_SOILS_VISIT %>% 
               #add in the table name to columns
               rename_with(.cols = !PLT_CN, 
                           ~paste0(.x, '.ENTIRE_SOILS_VISIT')), 
             by = join_by(PLT_CN)) %>%
  full_join(fia.ls$original_data$ENTIRE_SOILS_SAMPLE_LOC %>% 
              #add in the table name to columns
              rename_with(.cols = !PLT_CN, 
                          ~paste0(.x, '.ENTIRE_SOILS_SAMPLE_LOC')), 
            by = join_by(PLT_CN)) %>%
  full_join(fia.ls$original_data$ENTIRE_SOILS_EROSION %>%
              #add in the table name to columns
              rename_with(.cols = !PLT_CN, 
                          ~paste0(.x, '.ENTIRE_SOILS_EROSION')), ,
            by = join_by(PLT_CN),
            relationship = "many-to-many") %>%
  full_join(fia.ls$original_data$ENTIRE_SOILS_LAB %>%
              #add in the table name to columns
              rename_with(.cols = !PLT_CN, 
                          ~paste0(.x, '.ENTIRE_SOILS_LAB')), ,
            by = join_by(PLT_CN),
            relationship = "many-to-many") %>%
  filter(!is.na(C_ORG_PCT.ENTIRE_SOILS_LAB)) %>%
  #before pivot => 0.4 Gb
  #slice_head(n=100) %>%
  pivot_longer(cols = !c(starts_with('CN.'), PLT_CN), 
               values_drop_na = TRUE,
               names_to = c('column_id', 'table_id'),
               names_sep = '\\.',
               names_transform = as.factor,
               values_to = 'with_entry')
  #after pivot => 2.1 Gb

```

## Subseting for soil carbon

```{r}

soil_carbon.df <- fia.ls$annotations %>%
  filter(of_variable %in% c(
             'Inventory_year', #an identifier
             'Longtitude', 'Latitude', 'State',
             #'Forest_floor_depth_avg', 'Litter_layer_depth_avg',
             'Layer_type',
             'Bulk_density',
             'coarse_fraction',
             'organic_carbon',
             'carbon_fraction',
             'inorganic_carbon'),
         table_id %in% c('ENTIRE_PLOT', 'ENTIRE_SOILS_LAB'),
         with_entry == '--') %>%
  select(table_id, column_id, of_variable, is_type) %>%
  left_join(fia.ls$long_data,
            by = join_by(table_id, column_id),
            relationship = "many-to-many")  %>%
  filter(is_type == 'value') %>%
  select(starts_with('CN'), of_variable, with_entry) %>%
  unique() %>%
  tidyr::unite(col = row_id, starts_with('CN.'), sep = '::') %>%
  pivot_wider(names_from = of_variable,
               values_from = with_entry) %>%
  select(-row_id)
```

# Working with control vocabulary

```{r}
controlVocab <- fia.ls$annotations %>%
  filter(of_variable %in% c(
             'Inventory_year', #an identifier
             'Longtitude', 'Latitude', 'State',
             #'Forest_floor_depth_avg', 'Litter_layer_depth_avg',
             'Layer_type',
             'Bulk_density',
             'coarse_fraction',
             'organic_carbon',
             'carbon_fraction',
             'inorganic_carbon'),
         table_id %in% c('ENTIRE_PLOT', 'ENTIRE_SOILS_LAB'),
         is_type == 'control_vocabulary') %>%
  select(of_variable, with_entry) %>%
  unique() %>%
  separate_longer_delim(cols = with_entry, delim = ';') %>%
  separate_wider_delim(cols = with_entry, delim = '|', names =  c('value', 'definition'))
```

### State names

```{r}
soil_carbon.df <- soil_carbon.df %>%
  left_join(controlVocab %>%
              filter(of_variable == 'State') %>%
              select('state_name'= definition, value),
            by = join_by(State == value))
```

### Layer bounds

```{r}
soil_carbon.df <- soil_carbon.df %>%
  left_join( controlVocab %>%
               filter(of_variable == 'Layer_type') %>%
               mutate(Layer_type.upper = str_extract(definition, pattern = regex('^\\d(?=\\-\\d inch)')),
                      Layer_type.lower = str_extract(definition, pattern = regex('(?<=\\d\\-)\\d(?= inch)')),
                      Layer_type.unit = 'inch') %>%
               select(value, Layer_type.definition = definition, Layer_type.upper, Layer_type.lower, Layer_type.unit),
            by = join_by(Layer_type == value))
```

## Casting values

```{r}

soil_carbon.df <- soil_carbon.df %>%
  mutate(across(.cols = all_of(c("Inventory_year",
                               "Bulk_density", "coarse_fraction", 
                               "organic_carbon", 
                               "inorganic_carbon", "carbon_fraction", 
                               "Latitude", "Longtitude", 
                               'Layer_type.upper', 'Layer_type.lower')), as.numeric))
```

## Make small tables

```{r}
site.df <- soil_carbon.df %>%
  select(Latitude, Longtitude, Inventory_year) %>%
  unique()

layer.df <- soil_carbon.df %>%
  select(Latitude, Longtitude, Inventory_year, 
         Layer_type, Layer_type.definition, Layer_type.upper, Layer_type.lower,
         Bulk_density, coarse_fraction,
         organic_carbon, inorganic_carbon)

meta.df <- fia.ls$annotations %>%
  filter(of_variable %in% c(
             'Inventory_year', #an identifier
             'Longtitude', 'Latitude', 'State',
             #'Forest_floor_depth_avg', 'Litter_layer_depth_avg',
             'Layer_type',
             'Bulk_density',
             'coarse_fraction',
             'organic_carbon',
             'carbon_fraction',
             'inorganic_carbon'),
         table_id %in% c('ENTIRE_PLOT', 'ENTIRE_SOILS_LAB'))
```

# Figures and report

## Location over time

```{r, fig.width = 6, fig.height = 9}
ggplot(site.df %>%
         mutate(decade = floor(Inventory_year/5)*5)) +
  geom_point(aes(x=Longtitude, y = Latitude), alpha = .1) +
  facet_wrap(~decade, ncol = 1)
```

## Layer histograms

```{r}
ggplot(layer.df %>%
         pivot_longer(cols = where(is.numeric), values_drop_na = TRUE)) +
  geom_histogram(aes(x=value)) +
  facet_wrap(~name, scales='free')
```

## Bulk density vs organic carbon

```{r}

ggplot(layer.df) +
  geom_point(aes(x=Bulk_density, y = organic_carbon), alpha = 0.1) +
  facet_wrap(~Layer_type, scales='free')
```
